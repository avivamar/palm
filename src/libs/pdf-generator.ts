/**
 * PDF æŠ¥å‘Šç”Ÿæˆå™¨
 * ä½¿ç”¨ Puppeteer ç”Ÿæˆé«˜è´¨é‡çš„æ‰‹ç›¸åˆ†æPDFæŠ¥å‘Š
 */

import puppeteer from 'puppeteer';

export interface PalmReportData {
  title: string;
  subtitle: string;
  session: {
    id: string;
    type: string;
    handType: string;
    createdAt: string;
  };
  content: {
    personality?: {
      traits: string[];
      strengths: string[];
      challenges: string[];
      summary: string;
    };
    health?: {
      vitality: number;
      areas: string[];
      recommendations: string[];
      summary: string;
    };
    career?: {
      aptitudes: string[];
      opportunities: string[];
      challenges: string[];
      summary: string;
    };
    relationship?: {
      compatibility: string[];
      communication: string[];
      challenges: string[];
      summary: string;
    };
    fortune?: {
      financial: string[];
      opportunities: string[];
      timing: string[];
      summary: string;
    };
  };
  language: string;
  metadata: {
    generatedAt: Date;
    version: string;
    userId: string;
  };
}

/**
 * ç”Ÿæˆæ‰‹ç›¸åˆ†æPDFæŠ¥å‘Š
 */
export async function generatePalmPDFReport(data: PalmReportData): Promise<Buffer> {
  let browser: puppeteer.Browser | null = null;

  try {
    // å¯åŠ¨æµè§ˆå™¨
    browser = await puppeteer.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-accelerated-2d-canvas',
        '--no-first-run',
        '--no-zygote',
        '--single-process',
        '--disable-gpu'
      ]
    });

    const page = await browser.newPage();

    // è®¾ç½®é¡µé¢æ ¼å¼
    await page.setViewport({ width: 1200, height: 1600 });

    // ç”ŸæˆHTMLå†…å®¹
    const htmlContent = generateReportHTML(data);

    // è®¾ç½®HTMLå†…å®¹
    await page.setContent(htmlContent, { waitUntil: 'networkidle0' });

    // ç”ŸæˆPDF
    const pdfBuffer = await page.pdf({
      format: 'A4',
      printBackground: true,
      margin: {
        top: '20mm',
        right: '15mm',
        bottom: '20mm',
        left: '15mm'
      },
      displayHeaderFooter: true,
      headerTemplate: `
        <div style="font-size: 10px; color: #666; width: 100%; text-align: center; margin-top: 10px;">
          <span>${data.title} - ${data.session.type}</span>
        </div>
      `,
      footerTemplate: `
        <div style="font-size: 10px; color: #666; width: 100%; text-align: center; display: flex; justify-content: space-between; padding: 0 15mm;">
          <span>Generated by Palm AI - Powered by Rolitt</span>
          <span>Page <span class="pageNumber"></span> of <span class="totalPages"></span></span>
        </div>
      `
    });

    return pdfBuffer;

  } catch (error) {
    console.error('PDF generation failed:', error);
    throw new Error(`PDFç”Ÿæˆå¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`);
  } finally {
    if (browser) {
      await browser.close();
    }
  }
}

/**
 * ç”ŸæˆæŠ¥å‘ŠHTMLå†…å®¹
 */
function generateReportHTML(data: PalmReportData): string {
  const { content } = data;
  
  return `
    <!DOCTYPE html>
    <html lang="${data.language}">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>${data.title}</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                font-family: 'Helvetica Neue', Arial, sans-serif;
                line-height: 1.6;
                color: #333;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
            }
            
            .container {
                max-width: 800px;
                margin: 0 auto;
                background: white;
                min-height: 100vh;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
            }
            
            .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 40px 30px;
                text-align: center;
                position: relative;
                overflow: hidden;
            }
            
            .header::before {
                content: '';
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="palm" patternUnits="userSpaceOnUse" width="20" height="20"><circle cx="10" cy="10" r="2" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23palm)"/></svg>') repeat;
                animation: float 20s ease-in-out infinite;
            }
            
            @keyframes float {
                0%, 100% { transform: translateY(0px); }
                50% { transform: translateY(-10px); }
            }
            
            .header h1 {
                font-size: 2.5em;
                font-weight: 300;
                margin-bottom: 10px;
                position: relative;
                z-index: 1;
            }
            
            .header .subtitle {
                font-size: 1.1em;
                opacity: 0.9;
                position: relative;
                z-index: 1;
            }
            
            .session-info {
                background: #f8f9fa;
                padding: 20px 30px;
                border-bottom: 3px solid #667eea;
            }
            
            .session-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }
            
            .session-item {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            .session-label {
                font-weight: 600;
                color: #667eea;
                min-width: 80px;
            }
            
            .content {
                padding: 30px;
            }
            
            .section {
                margin-bottom: 40px;
                break-inside: avoid;
            }
            
            .section-title {
                font-size: 1.8em;
                font-weight: 600;
                color: #667eea;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 2px solid #667eea;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            .section-icon {
                width: 30px;
                height: 30px;
                border-radius: 50%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 1.2em;
            }
            
            .summary-box {
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                padding: 20px;
                border-radius: 10px;
                margin-bottom: 20px;
                border-left: 4px solid #667eea;
            }
            
            .summary-text {
                font-style: italic;
                font-size: 1.1em;
                line-height: 1.8;
                color: #555;
            }
            
            .traits-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }
            
            .trait-category {
                background: white;
                border: 1px solid #e9ecef;
                border-radius: 10px;
                padding: 20px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            }
            
            .trait-category h4 {
                font-size: 1.2em;
                margin-bottom: 15px;
                color: #667eea;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .trait-list {
                list-style: none;
            }
            
            .trait-list li {
                padding: 8px 0;
                border-bottom: 1px solid #f1f3f4;
                position: relative;
                padding-left: 20px;
            }
            
            .trait-list li:last-child {
                border-bottom: none;
            }
            
            .trait-list li::before {
                content: 'â—';
                color: #667eea;
                position: absolute;
                left: 0;
                top: 8px;
            }
            
            .vitality-score {
                text-align: center;
                margin: 20px 0;
            }
            
            .vitality-number {
                font-size: 3em;
                font-weight: bold;
                color: #667eea;
                display: block;
            }
            
            .vitality-label {
                font-size: 1.1em;
                color: #666;
                margin-top: 5px;
            }
            
            .progress-bar {
                width: 100%;
                height: 20px;
                background: #e9ecef;
                border-radius: 10px;
                overflow: hidden;
                margin: 10px 0;
            }
            
            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                border-radius: 10px;
                transition: width 0.3s ease;
            }
            
            .footer {
                background: #f8f9fa;
                padding: 30px;
                text-align: center;
                border-top: 1px solid #e9ecef;
                margin-top: 40px;
            }
            
            .footer-text {
                color: #666;
                font-size: 0.9em;
                line-height: 1.6;
            }
            
            .disclaimer {
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 10px;
                padding: 20px;
                margin: 30px 0;
            }
            
            .disclaimer-title {
                font-weight: 600;
                color: #856404;
                margin-bottom: 10px;
            }
            
            .disclaimer-text {
                color: #856404;
                font-size: 0.9em;
                line-height: 1.6;
            }
            
            @page {
                margin: 0;
            }
            
            @media print {
                body {
                    -webkit-print-color-adjust: exact;
                    print-color-adjust: exact;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <!-- å¤´éƒ¨ -->
            <div class="header">
                <h1>ğŸ–ï¸ ${data.title}</h1>
                <div class="subtitle">${data.subtitle}</div>
            </div>
            
            <!-- ä¼šè¯ä¿¡æ¯ -->
            <div class="session-info">
                <div class="session-grid">
                    <div class="session-item">
                        <span class="session-label">ä¼šè¯ID:</span>
                        <span>${data.session.id}</span>
                    </div>
                    <div class="session-item">
                        <span class="session-label">åˆ†æç±»å‹:</span>
                        <span>${data.session.type}</span>
                    </div>
                    <div class="session-item">
                        <span class="session-label">æ‰‹å‹:</span>
                        <span>${data.session.handType}</span>
                    </div>
                    <div class="session-item">
                        <span class="session-label">ç”Ÿæˆæ—¶é—´:</span>
                        <span>${data.session.createdAt}</span>
                    </div>
                </div>
            </div>
            
            <!-- ä¸»è¦å†…å®¹ -->
            <div class="content">
                ${generateSectionHTML('ğŸ§ ', 'ä¸ªæ€§åˆ†æ', content.personality)}
                ${generateSectionHTML('ğŸ’š', 'å¥åº·åˆ†æ', content.health)}
                ${generateSectionHTML('ğŸ’¼', 'äº‹ä¸šæ´å¯Ÿ', content.career)}
                ${generateSectionHTML('â¤ï¸', 'æ„Ÿæƒ…åˆ†æ', content.relationship)}
                ${generateSectionHTML('ğŸ€', 'è´¢è¿åˆ†æ', content.fortune)}
                
                <!-- å…è´£å£°æ˜ -->
                <div class="disclaimer">
                    <div class="disclaimer-title">âš ï¸ é‡è¦å£°æ˜</div>
                    <div class="disclaimer-text">
                        æœ¬æŠ¥å‘Šä»…ä¾›å¨±ä¹å‚è€ƒï¼Œä¸åº”ä½œä¸ºäººç”Ÿå†³ç­–çš„ä¾æ®ã€‚æ‰‹ç›¸åˆ†ææ˜¯ä¸€é—¨ä¼ ç»Ÿè‰ºæœ¯ï¼Œ
                        ç»“æœå¯èƒ½å› ä¸ªäººè§£è¯»è€Œå¼‚ã€‚è¯·ç†æ€§å¯¹å¾…åˆ†æç»“æœï¼Œé‡è¦å†³ç­–å»ºè®®å’¨è¯¢ä¸“ä¸šäººå£«ã€‚
                    </div>
                </div>
            </div>
            
            <!-- é¡µè„š -->
            <div class="footer">
                <div class="footer-text">
                    <strong>Palm AI - äººå·¥æ™ºèƒ½æ‰‹ç›¸åˆ†æ</strong><br>
                    Powered by Rolitt | ç”Ÿæˆæ—¶é—´: ${data.metadata.generatedAt.toLocaleString()}<br>
                    ç‰ˆæœ¬: ${data.metadata.version} | è¯­è¨€: ${data.language.toUpperCase()}
                </div>
            </div>
        </div>
    </body>
    </html>
  `;
}

/**
 * ç”Ÿæˆå„ä¸ªåˆ†æéƒ¨åˆ†çš„HTML
 */
function generateSectionHTML(icon: string, title: string, data: any): string {
  if (!data) return '';

  let contentHTML = '';

  // ç”Ÿæˆæ‘˜è¦
  if (data.summary) {
    contentHTML += `
      <div class="summary-box">
        <div class="summary-text">${data.summary}</div>
      </div>
    `;
  }

  // æ ¹æ®ä¸åŒç±»å‹ç”Ÿæˆå†…å®¹
  if (title === 'å¥åº·åˆ†æ' && data.vitality !== undefined) {
    contentHTML += `
      <div class="vitality-score">
        <span class="vitality-number">${data.vitality}</span>
        <div class="vitality-label">æ´»åŠ›æŒ‡æ•° / 100</div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${data.vitality}%"></div>
        </div>
      </div>
    `;
  }

  // ç”Ÿæˆç‰¹å¾åˆ—è¡¨
  const categories = [];
  
  if (data.traits) categories.push({ title: 'âœ¨ ä¸»è¦ç‰¹è´¨', items: data.traits });
  if (data.strengths) categories.push({ title: 'ğŸ’ª ä¼˜åŠ¿ç‰¹å¾', items: data.strengths });
  if (data.challenges) categories.push({ title: 'ğŸ¯ æˆé•¿ç©ºé—´', items: data.challenges });
  if (data.areas) categories.push({ title: 'ğŸ” å…³æ³¨é¢†åŸŸ', items: data.areas });
  if (data.recommendations) categories.push({ title: 'ğŸ’¡ å»ºè®®', items: data.recommendations });
  if (data.aptitudes) categories.push({ title: 'ğŸŒŸ å¤©èµ‹æ‰èƒ½', items: data.aptitudes });
  if (data.opportunities) categories.push({ title: 'ğŸš€ å‘å±•æœºé‡', items: data.opportunities });
  if (data.compatibility) categories.push({ title: 'ğŸ’• å…¼å®¹ç‰¹è´¨', items: data.compatibility });
  if (data.communication) categories.push({ title: 'ğŸ—£ï¸ æ²Ÿé€šæ–¹å¼', items: data.communication });
  if (data.financial) categories.push({ title: 'ğŸ’° è´¢åŠ¡çŠ¶å†µ', items: data.financial });
  if (data.timing) categories.push({ title: 'â° æœ€ä½³æ—¶æœº', items: data.timing });

  if (categories.length > 0) {
    contentHTML += '<div class="traits-grid">';
    categories.forEach(category => {
      contentHTML += `
        <div class="trait-category">
          <h4>${category.title}</h4>
          <ul class="trait-list">
            ${category.items.map((item: string) => `<li>${item}</li>`).join('')}
          </ul>
        </div>
      `;
    });
    contentHTML += '</div>';
  }

  return `
    <div class="section">
      <div class="section-title">
        <div class="section-icon">${icon}</div>
        ${title}
      </div>
      ${contentHTML}
    </div>
  `;
}