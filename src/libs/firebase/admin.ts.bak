import { Env } from '@/libs/Env';

// æ£€æŸ¥æ˜¯å¦åœ¨ Cloudflare Workers ç¯å¢ƒä¸­
const isCloudflareWorkers = typeof globalThis.navigator !== 'undefined'
  && globalThis.navigator.userAgent === 'Cloudflare-Workers';

// æ£€æŸ¥æ˜¯å¦åœ¨ Vercel ç¯å¢ƒä¸­
const isVercelEnvironment = process.env.VERCEL === '1';

// æ£€æŸ¥æ˜¯å¦åœ¨æœåŠ¡å™¨ç¯å¢ƒä¸­ä¸”ä¸æ˜¯ Cloudflare Workers
const isServerEnvironment = typeof window === 'undefined' && !isCloudflareWorkers;

// è®¾ç½®åˆå§‹åŒ–è¶…æ—¶
const INIT_TIMEOUT = isVercelEnvironment ? 10000 : 30000; // Vercel 10s, å…¶ä»– 30s

/**
 * è¶…æ—¶åŒ…è£…å™¨å‡½æ•°
 */
function withTimeout<T>(promise: Promise<T>, timeoutMs: number): Promise<T> {
  return Promise.race([
    promise,
    new Promise<never>((_, reject) =>
      setTimeout(() => reject(new Error(`Operation timed out after ${timeoutMs}ms`)), timeoutMs),
    ),
  ]);
}

let app: any = null;
let adminAuth: any = null;
let isInitialized = false;
let initializationError: string | null = null;

/**
 * ğŸ”¥ Enhanced Firebase Admin åˆå§‹åŒ–å‡½æ•°
 * å¢å¼ºé”™è¯¯å¤„ç†ã€è¯¦ç»†è°ƒè¯•ä¿¡æ¯ã€ç¯å¢ƒå˜é‡éªŒè¯ã€Vercel ä¼˜åŒ–
 */
async function initializeFirebaseAdmin() {
  if (isInitialized) {
    console.error(`[FirebaseAdmin] Already initialized: ${app ? 'Success' : 'Failed'}`);
    return { app, adminAuth, error: initializationError };
  }

  if (!isServerEnvironment) {
    console.error('[FirebaseAdmin] Not in server environment, skipping initialization');
    return { app: null, adminAuth: null, error: 'Not in server environment' };
  }

  try {
    console.error(`[FirebaseAdmin] ğŸ”¥ Starting enhanced Firebase Admin initialization (Vercel: ${isVercelEnvironment}, Timeout: ${INIT_TIMEOUT}ms)...`);

    // ä½¿ç”¨è¶…æ—¶åŒ…è£…å™¨
    const result = await withTimeout(
      performFirebaseInitialization(),
      INIT_TIMEOUT,
    );

    return result;
  } catch (error) {
    // è¯¦ç»†é”™è¯¯æ—¥å¿—
    console.error('[FirebaseAdmin] Initialization failed:', {
      error: error instanceof Error ? error.message : String(error),
      isVercel: isVercelEnvironment,
      timeout: INIT_TIMEOUT,
      env: {
        hasServiceAccount: !!Env.FIREBASE_SERVICE_ACCOUNT_KEY,
        hasProjectId: !!Env.FIREBASE_PROJECT_ID,
        hasPrivateKey: !!Env.FIREBASE_PRIVATE_KEY,
        hasClientEmail: !!Env.FIREBASE_CLIENT_EMAIL,
      },
    });

    initializationError = error instanceof Error ? error.message : String(error);
    isInitialized = true;
    return { app: null, adminAuth: null, error: initializationError };
  }
}

/**
 * ğŸ”¥ æ‰§è¡Œ Firebase åˆå§‹åŒ–çš„æ ¸å¿ƒé€»è¾‘
 */
async function performFirebaseInitialization() {
  try {
    console.error('[FirebaseAdmin] ğŸ”¥ Starting core Firebase Admin initialization...');

    // ğŸ”§ Step 1: éªŒè¯ç¯å¢ƒå˜é‡
    const envValidation = validateFirebaseEnvironment();
    if (!envValidation.valid) {
      initializationError = `Environment validation failed: ${envValidation.error}`;
      console.error(`[FirebaseAdmin] âŒ ${initializationError}`);
      isInitialized = true; // æ ‡è®°ä¸ºå·²å°è¯•åˆå§‹åŒ–ï¼Œé¿å…é‡å¤
      return { app: null, adminAuth: null, error: initializationError };
    }

    console.error('[FirebaseAdmin] âœ… Environment variables validation passed');

    // ğŸ”§ Step 2: åŠ¨æ€å¯¼å…¥Firebaseæ¨¡å—
    console.error('[FirebaseAdmin] ğŸ“¦ Loading Firebase Admin modules...');
    const { getApps, initializeApp, cert } = await import('firebase-admin/app');
    const { getAuth } = await import('firebase-admin/auth');
    console.error('[FirebaseAdmin] âœ… Firebase Admin modules loaded successfully');

    // ğŸ”§ Step 3: å‡†å¤‡å‡­è¯
    const credential = await prepareFirebaseCredential(cert);
    if (!credential) {
      initializationError = 'Failed to prepare Firebase credential';
      console.error(`[FirebaseAdmin] âŒ ${initializationError}`);
      isInitialized = true;
      return { app: null, adminAuth: null, error: initializationError };
    }

    console.error('[FirebaseAdmin] âœ… Firebase credential prepared successfully');

    // ğŸ”§ Step 4: åˆå§‹åŒ–åº”ç”¨
    if (getApps().length === 0) {
      console.error('[FirebaseAdmin] ğŸš€ Initializing new Firebase app...');
      app = initializeApp({
        credential,
        projectId: Env.FIREBASE_PROJECT_ID || Env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
      });
      console.error(`[FirebaseAdmin] âœ… New Firebase app initialized: ${app.name}`);
    } else {
      app = getApps()[0];
      console.error(`[FirebaseAdmin] âœ… Using existing Firebase app: ${app.name}`);
    }

    // ğŸ”§ Step 5: åˆå§‹åŒ–Auth
    console.error('[FirebaseAdmin] ğŸ”‘ Initializing Firebase Auth...');
    adminAuth = getAuth(app);
    console.error('[FirebaseAdmin] âœ… Firebase Auth initialized successfully');

    // ğŸ”§ Step 6: æµ‹è¯•è¿æ¥ï¼ˆåœ¨ Vercel ç¯å¢ƒä¸­è·³è¿‡ä»¥å‡å°‘åˆå§‹åŒ–æ—¶é—´ï¼‰
    if (!isVercelEnvironment) {
      await testFirebaseConnection(adminAuth);
    } else {
      console.error('[FirebaseAdmin] âš¡ Skipping connection test in Vercel environment for faster initialization');
    }

    isInitialized = true;
    initializationError = null;
    console.error('[FirebaseAdmin] ğŸ‰ Firebase Admin initialization completed successfully!');

    return { app, adminAuth, error: null };
  } catch (error) {
    const errorMessage = `Firebase Admin initialization failed: ${error instanceof Error ? error.message : String(error)}`;
    console.error(`[FirebaseAdmin] âŒ Critical error:`, error);

    // è¯¦ç»†é”™è¯¯ä¿¡æ¯
    if (error instanceof Error) {
      console.error(`[FirebaseAdmin] Error name: ${error.name}`);
      console.error(`[FirebaseAdmin] Error message: ${error.message}`);
      console.error(`[FirebaseAdmin] Error stack: ${error.stack}`);
    }

    app = null;
    adminAuth = null;
    isInitialized = true; // æ ‡è®°ä¸ºå·²å°è¯•ï¼Œé¿å…é‡å¤åˆå§‹åŒ–
    throw new Error(errorMessage);
  }
}

/**
 * ğŸ” éªŒè¯Firebaseç¯å¢ƒå˜é‡
 */
function validateFirebaseEnvironment(): { valid: boolean; error?: string } {
  console.error('[FirebaseAdmin] ğŸ” Validating Firebase environment variables...');
  
  // åœ¨æ„å»ºæ—¶è·³è¿‡éªŒè¯ï¼Œé¿å…æ„å»ºå¤±è´¥
  const isBuildTime = process.env.NEXT_PHASE === 'phase-production-build' || 
    (typeof window === 'undefined' && !process.env.RAILWAY_ENVIRONMENT && !process.env.VERCEL && !process.env.FIREBASE_SERVICE_ACCOUNT_KEY);
  
  if (isBuildTime) {
    console.warn('[FirebaseAdmin] âš ï¸ Skipping Firebase validation during build time');
    return { valid: false, error: 'Build time - Firebase validation skipped' };
  }

  // æ–¹æ³•1: æ£€æŸ¥ FIREBASE_SERVICE_ACCOUNT_KEY
  if (Env.FIREBASE_SERVICE_ACCOUNT_KEY) {
    console.error('[FirebaseAdmin] Found FIREBASE_SERVICE_ACCOUNT_KEY');
    try {
      const parsed = JSON.parse(Env.FIREBASE_SERVICE_ACCOUNT_KEY);
      if (parsed.type === 'service_account' && parsed.project_id && parsed.private_key && parsed.client_email) {
        console.error('[FirebaseAdmin] âœ… FIREBASE_SERVICE_ACCOUNT_KEY is valid');
        return { valid: true };
      } else {
        console.error('[FirebaseAdmin] âŒ FIREBASE_SERVICE_ACCOUNT_KEY missing required fields');
        return { valid: false, error: 'FIREBASE_SERVICE_ACCOUNT_KEY missing required fields' };
      }
    } catch (e) {
      console.error('[FirebaseAdmin] âŒ FIREBASE_SERVICE_ACCOUNT_KEY is not valid JSON:', e);
      return { valid: false, error: 'FIREBASE_SERVICE_ACCOUNT_KEY is not valid JSON' };
    }
  }

  // æ–¹æ³•2: æ£€æŸ¥åˆ†ç¦»çš„ç¯å¢ƒå˜é‡
  const projectId = Env.FIREBASE_PROJECT_ID || Env.NEXT_PUBLIC_FIREBASE_PROJECT_ID;
  const privateKey = Env.FIREBASE_PRIVATE_KEY;
  const clientEmail = Env.FIREBASE_CLIENT_EMAIL;

  if (projectId && privateKey && clientEmail) {
    console.error('[FirebaseAdmin] Found separate Firebase environment variables');
    console.error(`[FirebaseAdmin] Project ID: ${projectId}`);
    console.error(`[FirebaseAdmin] Client Email: ${clientEmail}`);
    console.error(`[FirebaseAdmin] Private Key: ${privateKey ? `${privateKey.substring(0, 50)}...` : 'missing'}`);
    return { valid: true };
  }

  console.error('[FirebaseAdmin] âŒ No valid Firebase configuration found');
  console.error('[FirebaseAdmin] Available env vars:');
  console.error(`[FirebaseAdmin] - FIREBASE_SERVICE_ACCOUNT_KEY: ${Env.FIREBASE_SERVICE_ACCOUNT_KEY ? 'present' : 'missing'}`);
  console.error(`[FirebaseAdmin] - FIREBASE_PROJECT_ID: ${Env.FIREBASE_PROJECT_ID || 'missing'}`);
  console.error(`[FirebaseAdmin] - NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${Env.NEXT_PUBLIC_FIREBASE_PROJECT_ID || 'missing'}`);
  console.error(`[FirebaseAdmin] - FIREBASE_PRIVATE_KEY: ${Env.FIREBASE_PRIVATE_KEY ? 'present' : 'missing'}`);
  console.error(`[FirebaseAdmin] - FIREBASE_CLIENT_EMAIL: ${Env.FIREBASE_CLIENT_EMAIL || 'missing'}`);

  return {
    valid: false,
    error: 'No valid Firebase configuration found. Need either FIREBASE_SERVICE_ACCOUNT_KEY or (FIREBASE_PROJECT_ID + FIREBASE_PRIVATE_KEY + FIREBASE_CLIENT_EMAIL)',
  };
}

/**
 * ğŸ”§ å‡†å¤‡Firebaseå‡­è¯
 */
async function prepareFirebaseCredential(cert: any): Promise<any> {
  console.error('[FirebaseAdmin] ğŸ”§ Preparing Firebase credential...');

  // ä¼˜å…ˆä½¿ç”¨ FIREBASE_SERVICE_ACCOUNT_KEY
  if (Env.FIREBASE_SERVICE_ACCOUNT_KEY) {
    try {
      console.error('[FirebaseAdmin] Using FIREBASE_SERVICE_ACCOUNT_KEY method');
      const serviceAccount = JSON.parse(Env.FIREBASE_SERVICE_ACCOUNT_KEY);
      const credential = cert(serviceAccount);
      console.error('[FirebaseAdmin] âœ… Credential created from FIREBASE_SERVICE_ACCOUNT_KEY');
      return credential;
    } catch (e) {
      console.error('[FirebaseAdmin] âŒ Failed to create credential from FIREBASE_SERVICE_ACCOUNT_KEY:', e);
      return null;
    }
  }

  // å›é€€åˆ°åˆ†ç¦»çš„ç¯å¢ƒå˜é‡
  const projectId = Env.FIREBASE_PROJECT_ID || Env.NEXT_PUBLIC_FIREBASE_PROJECT_ID;
  const privateKey = Env.FIREBASE_PRIVATE_KEY;
  const clientEmail = Env.FIREBASE_CLIENT_EMAIL;

  if (projectId && privateKey && clientEmail) {
    try {
      console.error('[FirebaseAdmin] Using separate environment variables method');

      // å¤„ç†ç§é’¥æ ¼å¼
      const processedPrivateKey = privateKey.replace(/\\n/g, '\n');
      console.error(`[FirebaseAdmin] Private key processed, length: ${processedPrivateKey.length}`);

      const credential = cert({
        projectId,
        clientEmail,
        privateKey: processedPrivateKey,
      });

      console.error('[FirebaseAdmin] âœ… Credential created from separate environment variables');
      return credential;
    } catch (e) {
      console.error('[FirebaseAdmin] âŒ Failed to create credential from separate variables:', e);
      return null;
    }
  }

  console.error('[FirebaseAdmin] âŒ No valid credential configuration found');
  return null;
}

/**
 * ğŸ§ª æµ‹è¯•Firebaseè¿æ¥
 */
async function testFirebaseConnection(auth: any): Promise<void> {
  try {
    console.error('[FirebaseAdmin] ğŸ§ª Testing Firebase connection...');

    // ç®€å•çš„æµ‹è¯•ï¼šå°è¯•è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆæœ€å¤š1ä¸ªï¼‰
    const listResult = await auth.listUsers(1);
    console.error(`[FirebaseAdmin] âœ… Connection test passed. Users found: ${listResult.users.length}`);
  } catch (error) {
    console.error('[FirebaseAdmin] âš ï¸ Connection test failed:', error);
    throw new Error(`Firebase connection test failed: ${error instanceof Error ? error.message : String(error)}`);
  }
}

/**
 * ğŸ”¥ è·å– Firebase Admin å®ä¾‹çš„å‡½æ•°
 */
export async function getFirebaseAdmin() {
  // åœ¨æ„å»ºæ—¶è¿”å›å®‰å…¨çš„é»˜è®¤å€¼
  const isBuildTime = process.env.NEXT_PHASE === 'phase-production-build' || 
    (typeof window === 'undefined' && !process.env.RAILWAY_ENVIRONMENT && !process.env.VERCEL && !process.env.FIREBASE_SERVICE_ACCOUNT_KEY);
  
  if (isBuildTime) {
    console.warn('[FirebaseAdmin] âš ï¸ Build time detected - returning null Firebase Admin');
    return {
      app: null,
      adminAuth: null,
      error: 'Build time - Firebase Admin not available',
      isInitialized: false,
    };
  }

  const result = await initializeFirebaseAdmin();

  if (result.error) {
    console.error(`[FirebaseAdmin] getFirebaseAdmin() called but initialization failed: ${result.error}`);
  }

  return {
    app: result.app,
    adminAuth: result.adminAuth,
    error: result.error,
    isInitialized: isInitialized && !result.error,
  };
}

/**
 * ğŸ” è·å–Firebase AdminçŠ¶æ€
 */
export function getFirebaseAdminStatus() {
  return {
    isInitialized,
    hasApp: !!app,
    hasAuth: !!adminAuth,
    error: initializationError,
  };
}

// å…¼å®¹æ€§å¯¼å‡º
export const getAdminAuth = () => adminAuth;
export const getApp = () => app;
export default getApp;
