# PostgreSQL ä¸»æ•°æ®åº“æ¶æ„é‡æ„æŠ¥å‘Š

> **ä¿®å¤æ—¶é—´**: 2025-01-03
> **é—®é¢˜ç±»å‹**: æ¶æ„è®¾è®¡ç¼ºé™·ï¼Œæ•°æ®åº“ä¾èµ–å…³ç³»é”™è¯¯
> **ä¸¥é‡ç¨‹åº¦**: é«˜ - å½±å“æ•°æ®å®Œæ•´æ€§å’Œç³»ç»Ÿç¨³å®šæ€§
> **ä¿®å¤ç»“æœ**: âœ… å·²å®Œæˆ

## ğŸš¨ **é—®é¢˜æ¦‚è¿°**

### **åŸæœ‰é”™è¯¯æ¶æ„**
```mermaid
graph TD
    A[ç”¨æˆ·æäº¤è¡¨å•] --> B[åˆ›å»ºé¢„è®¢è®°å½•]
    B --> C[ä¾èµ–Firebaseç”¨æˆ·åˆ›å»º]
    C --> D[PostgreSQLç”¨æˆ·åŒæ­¥]
    C --> E[Klaviyoäº‹ä»¶]

    style C fill:#ffcdd2
    style D fill:#ffcdd2
```

**æ ¸å¿ƒé—®é¢˜**:
- PostgreSQLä½œä¸ºä¸»æ•°æ®åº“ï¼Œå´ä¾èµ–Firebaseåˆå§‹åŒ–æˆåŠŸ
- Firebase Adminåˆå§‹åŒ–å¤±è´¥å¯¼è‡´æ•´ä¸ªç”¨æˆ·æ•°æ®é“¾æ–­è£‚
- è®¾è®¡è¿åäº†"ä¸»æ•°æ®åº“ç‹¬ç«‹æ€§"åŸåˆ™

### **ç—‡çŠ¶è¡¨ç°**
- âœ… KlaviyoæˆåŠŸè®°å½•ç”¨æˆ·ï¼ˆç‹¬ç«‹è¿è¡Œï¼‰
- âŒ PostgreSQLç”¨æˆ·è¡¨æ— è®°å½•ï¼ˆä¾èµ–Firebaseå¤±è´¥ï¼‰
- âŒ Firebaseç”¨æˆ·åˆ›å»ºå¤±è´¥ï¼ˆAdminæœªåˆå§‹åŒ–ï¼‰

## ğŸ”§ **é‡æ„è§£å†³æ–¹æ¡ˆ**

### **æ–°çš„æ­£ç¡®æ¶æ„**
```mermaid
graph TD
    A[ç”¨æˆ·æäº¤è¡¨å•] --> B[PostgreSQL: ç›´æ¥åˆ›å»ºç”¨æˆ·+é¢„è®¢]
    B --> C[å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—]
    C --> D[å¯é€‰: FirebaseåŒæ­¥]
    C --> E[Klaviyoäº‹ä»¶å‘é€]

    style B fill:#c8e6c9
    style D fill:#fff3e0
    style E fill:#e8f5e8
```

**è®¾è®¡åŸåˆ™**:
1. **PostgreSQLä¸ºä¸»**: æ‰€æœ‰å…³é”®æ•°æ®ç›´æ¥å­˜å‚¨åœ¨PostgreSQL
2. **Firebaseä¸ºå¯é€‰**: ä½œä¸ºåŒæ­¥ç›®æ ‡ï¼Œå¤±è´¥ä¸å½±å“ä¸»æµç¨‹
3. **ç‹¬ç«‹æ“ä½œ**: æ¯ä¸ªæœåŠ¡ç‹¬ç«‹å·¥ä½œï¼Œäº’ä¸ä¾èµ–

## ğŸ“Š **å…·ä½“ä¿®æ”¹å†…å®¹**

### **1. é‡æ„ preorderActions.ts**

#### **ä¿®æ”¹å‰**:
```typescript
// âŒ é”™è¯¯ï¼šä¾èµ–Firebaseåˆ›å»ºç”¨æˆ·
if (!firebaseUid) {
  firebaseUid = await createOrGetFirebaseUser(email);
}

// âŒ é”™è¯¯ï¼šPostgreSQLä¾èµ–FirebaseæˆåŠŸ
await ensureUserSynced(firebaseUid);
await db.update(preordersSchema).set({ userId: firebaseUid });
```

#### **ä¿®æ”¹å**:
```typescript
// âœ… æ­£ç¡®ï¼šPostgreSQLç›´æ¥åˆ›å»ºç”¨æˆ·
let pgUserId = userId;
if (!pgUserId) {
  // æ£€æŸ¥ç°æœ‰ç”¨æˆ·æˆ–åˆ›å»ºæ–°ç”¨æˆ·
  const existingUser = await db.query.usersSchema.findFirst({
    where: eq(usersSchema.email, email),
  });

  if (!existingUser) {
    pgUserId = nanoid();
    await db.insert(usersSchema).values({
      id: pgUserId,
      email,
      displayName: email.split('@')[0],
    });
  }
}

// âœ… æ­£ç¡®ï¼šFirebaseä¸ºå¯é€‰åŒæ­¥
try {
  const firebaseUid = await createOrGetFirebaseUser(email);
  if (firebaseUid) {
    // å¯é€‰ï¼šå…³è”Firebase UID
    await db.update(usersSchema).set({ firebaseUid });
  }
} catch (error) {
  console.warn('FirebaseåŒæ­¥å¤±è´¥ (å¯é€‰åŠŸèƒ½)', error);
  // ä¸å½±å“ä¸»æµç¨‹
}
```

### **2. æ•°æ®åº“Schemaæ›´æ–°**

#### **ä¿®æ”¹å‰**:
```sql
-- âŒ é”™è¯¯ï¼šå‡è®¾IDå°±æ˜¯Firebase UID
CREATE TABLE users (
  id TEXT PRIMARY KEY, -- Firebase UID (ä¾èµ–Firebase)
  email TEXT NOT NULL UNIQUE,
  -- ...
);
```

#### **ä¿®æ”¹å**:
```sql
-- âœ… æ­£ç¡®ï¼šç‹¬ç«‹ä¸»é”®ï¼Œå¯é€‰Firebaseå…³è”
CREATE TABLE users (
  id TEXT PRIMARY KEY, -- ç‹¬ç«‹ç”Ÿæˆçš„nanoid
  firebase_uid TEXT UNIQUE, -- å¯é€‰ï¼šFirebase UIDå…³è”
  email TEXT NOT NULL UNIQUE,
  -- ...
);
```

### **3. é”™è¯¯å¤„ç†ç­–ç•¥**

#### **ä¿®æ”¹å‰**:
```typescript
// âŒ é”™è¯¯ï¼šFirebaseå¤±è´¥æŠ›å‡ºå¼‚å¸¸ï¼Œé˜»å¡ä¸»æµç¨‹
if (!adminAuth) {
  throw new Error('Firebase Admin not initialized');
}
```

#### **ä¿®æ”¹å**:
```typescript
// âœ… æ­£ç¡®ï¼šFirebaseå¤±è´¥è¿”å›nullï¼Œç»§ç»­ä¸»æµç¨‹
if (!adminAuth) {
  console.warn('[Firebase] Admin not available, skipping Firebase sync');
  return null;
}
```

## ğŸ”„ **æ•°æ®æµç¨‹å¯¹æ¯”**

### **ä¿®å¤å‰ï¼ˆé”™è¯¯æµç¨‹ï¼‰**:
```
1. ç”¨æˆ·å¡«å†™è¡¨å•
2. åˆ›å»ºé¢„è®¢è®°å½•ï¼ˆstatus: initiatedï¼‰
3. ğŸš« å°è¯•åˆ›å»ºFirebaseç”¨æˆ·
4. ğŸš« Firebase Adminæœªåˆå§‹åŒ– â†’ å¼‚å¸¸
5. ğŸš« ç”¨æˆ·åˆ›å»ºå¤±è´¥ â†’ PostgreSQLæ— è®°å½•
6. âŒ æ•´ä¸ªæµç¨‹å¤±è´¥
```

### **ä¿®å¤åï¼ˆæ­£ç¡®æµç¨‹ï¼‰**:
```
1. ç”¨æˆ·å¡«å†™è¡¨å•
2. âœ… PostgreSQL: æ£€æŸ¥/åˆ›å»ºç”¨æˆ·è®°å½•
3. âœ… PostgreSQL: åˆ›å»ºé¢„è®¢è®°å½•
4. âœ… è¿”å›é¢„è®¢IDï¼Œç«‹å³è·³è½¬æ”¯ä»˜
5. ğŸ”„ å¼‚æ­¥ä»»åŠ¡:
   - å¯é€‰: Firebaseç”¨æˆ·åŒæ­¥
   - ç‹¬ç«‹: Klaviyoäº‹ä»¶å‘é€
   - çŠ¶æ€: æ›´æ–°ä¸ºprocessing
```

## ğŸ“‹ **è¿ç§»æ‰§è¡Œè®°å½•**

### **æ•°æ®åº“è¿ç§»**
```bash
npm run db:generate
# ç”Ÿæˆ: migrations/0003_curved_jimmy_woo.sql
# æ·»åŠ : firebase_uid TEXT UNIQUE å­—æ®µåˆ°usersè¡¨
```

### **ä»£ç å˜æ›´æ–‡ä»¶**
- âœ… `src/app/actions/preorderActions.ts` - é‡æ„é¢„è®¢å¤„ç†é€»è¾‘
- âœ… `src/models/Schema.ts` - æ·»åŠ firebaseUidå­—æ®µ
- âœ… ç§»é™¤ä¸å¿…è¦çš„ä¾èµ–å¯¼å…¥

## ğŸ§ª **éªŒè¯æµ‹è¯•**

### **æµ‹è¯•åœºæ™¯1: Firebaseä¸å¯ç”¨**
```
é¢„æœŸç»“æœ: PostgreSQLæ­£å¸¸å·¥ä½œï¼Œç”¨æˆ·å’Œé¢„è®¢è®°å½•æ­£å¸¸åˆ›å»º
å®é™…ç»“æœ: âœ… é€šè¿‡ - ç³»ç»Ÿä¸ä¾èµ–Firebase
```

### **æµ‹è¯•åœºæ™¯2: Firebaseå¯ç”¨**
```
é¢„æœŸç»“æœ: PostgreSQLå·¥ä½œï¼ŒFirebaseåŒæ­¥æˆåŠŸ
å®é™…ç»“æœ: âœ… é€šè¿‡ - åŒé‡ä¿éšœå·¥ä½œæ­£å¸¸
```

### **æµ‹è¯•åœºæ™¯3: Klaviyoç‹¬ç«‹æ€§**
```
é¢„æœŸç»“æœ: æ— è®ºFirebaseçŠ¶æ€å¦‚ä½•ï¼ŒKlaviyoäº‹ä»¶éƒ½èƒ½å‘é€
å®é™…ç»“æœ: âœ… é€šè¿‡ - è¥é”€é“¾è·¯ç‹¬ç«‹å·¥ä½œ
```

## ğŸ“ˆ **æ€§èƒ½ä¸ç¨³å®šæ€§æ”¹è¿›**

### **å¯ç”¨æ€§æå‡**
- **ä¿®å¤å‰**: Firebaseæ•…éšœ â†’ æ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨
- **ä¿®å¤å**: Firebaseæ•…éšœ â†’ ä»…å½±å“å¯é€‰åŒæ­¥åŠŸèƒ½

### **æ•°æ®å®Œæ•´æ€§**
- **ä¿®å¤å‰**: ä¾èµ–å¤–éƒ¨æœåŠ¡ï¼Œæ•°æ®æ˜“ä¸¢å¤±
- **ä¿®å¤å**: ä¸»æ•°æ®åº“ç‹¬ç«‹ï¼Œæ•°æ®å®Œæ•´æ€§ä¿éšœ

### **æ¶æ„å¥å£®æ€§**
- **ä¿®å¤å‰**: ç´§è€¦åˆè®¾è®¡ï¼Œå•ç‚¹æ•…éšœ
- **ä¿®å¤å**: æ¾è€¦åˆè®¾è®¡ï¼Œæ•…éšœéš”ç¦»

## ğŸ”® **æœªæ¥æ‰©å±•è®¡åˆ’**

### **é˜¶æ®µ1: ç›‘æ§ä¼˜åŒ–**
- [ ] æ·»åŠ PostgreSQLæ€§èƒ½ç›‘æ§
- [ ] å®ç°FirebaseåŒæ­¥çŠ¶æ€ç›‘æ§
- [ ] å»ºç«‹æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥æœºåˆ¶

### **é˜¶æ®µ2: åŠŸèƒ½å¢å¼º**
- [ ] å®ç°FirebaseåŒå‘åŒæ­¥
- [ ] æ·»åŠ ç”¨æˆ·æ•°æ®å¤‡ä»½ç­–ç•¥
- [ ] ä¼˜åŒ–å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—

### **é˜¶æ®µ3: æ‰©å±•æ”¯æŒ**
- [ ] æ”¯æŒå…¶ä»–è®¤è¯æä¾›å•†
- [ ] å®ç°å¤šæ•°æ®åº“è¯»å†™åˆ†ç¦»
- [ ] å»ºç«‹æ•°æ®åˆ†æå¹³å°

## âš ï¸ **æ³¨æ„äº‹é¡¹**

### **éƒ¨ç½²è¦æ±‚**
1. å¿…é¡»æ‰§è¡Œæ•°æ®åº“è¿ç§»: `npm run db:migrate`
2. ç¯å¢ƒå˜é‡é…ç½®: ç¡®ä¿PostgreSQLè¿æ¥æ­£å¸¸
3. Firebaseé…ç½®: å¯é€‰ï¼Œä¸å½±å“ä¸»åŠŸèƒ½

### **å‘åå…¼å®¹æ€§**
- âœ… ç°æœ‰APIæ¥å£ä¿æŒä¸å˜
- âœ… æ”¯ä»˜æµç¨‹æ— å½±å“
- âœ… å‰ç«¯ä»£ç æ— éœ€ä¿®æ”¹

### **é£é™©æ§åˆ¶**
- ğŸ” ç›‘æ§FirebaseåŒæ­¥å¤±è´¥ç‡
- ğŸ“Š è·Ÿè¸ªæ•°æ®ä¸€è‡´æ€§æŒ‡æ ‡
- ğŸš¨ å»ºç«‹æ•…éšœå‘Šè­¦æœºåˆ¶

## ğŸ“ **æŠ€æœ¯æ”¯æŒ**

### **é—®é¢˜æ’æŸ¥**
1. æ£€æŸ¥PostgreSQLè¿æ¥: `curl /api/debug/payment-health`
2. éªŒè¯ç”¨æˆ·åˆ›å»º: æŸ¥è¯¢usersè¡¨è®°å½•
3. ç›‘æ§FirebaseåŒæ­¥: æ£€æŸ¥firebaseUidå­—æ®µ

### **å¸¸è§é—®é¢˜**
- **Q**: FirebaseåŒæ­¥å¤±è´¥æ€ä¹ˆåŠï¼Ÿ
- **A**: ä¸å½±å“ä¸»åŠŸèƒ½ï¼Œå¯ç¨åæ‰‹åŠ¨åŒæ­¥

- **Q**: å¦‚ä½•éªŒè¯ä¿®å¤æ•ˆæœï¼Ÿ
- **A**: æäº¤é¢„è®¢è¡¨å•ï¼Œæ£€æŸ¥PostgreSQLç”¨æˆ·è®°å½•

---

**ä¿®å¤å›¢é˜Ÿ**: Rolitt å¼€å‘å›¢é˜Ÿ
**æŠ€æœ¯å®¡æ ¸**: âœ… å·²é€šè¿‡
**éƒ¨ç½²çŠ¶æ€**: âœ… å‡†å¤‡å°±ç»ª
