ä¸‹é¢æ˜¯å¢å¼ºç‰ˆçš„ Rolitt é¢„å”®æ”¯ä»˜ä¸ Klaviyo è¥é”€é›†æˆæ–¹æ¡ˆ v2.0ï¼ŒåŸºäºä½ æä¾›çš„æ–‡æ¡£å†…å®¹ï¼ŒåŠ å…¥ä¼˜åŒ–å»ºè®®ä¸å·¥å…·é…åˆå‚è€ƒï¼ˆå« Stripe Ã— Klaviyo é›†æˆæœ€ä½³å®è·µï¼‰ï¼š

â¸»

ğŸ“Š ä¸€ã€ç³»ç»Ÿæ¶æ„ä¸æ•°æ®æµï¼ˆä¼˜åŒ–ç‰ˆï¼‰

flowchart TD
  A[ç”¨æˆ·åœ¨é¢„å”®é¡µé€‰æ‹©é¢œè‰²/è¾“å…¥é‚®ç®±] --> B{è°ƒç”¨ POST /api/payments/create-intent}
  B --> C[Stripe åˆ›å»º Customer & Checkout Session]
  C -->|sessionId| A
  A --> D[Stripe æ‰˜ç®¡æ”¯ä»˜é¡µ]

  subgraph å¼‚æ­¥ Webhook äº‹ä»¶
    C --> E[/api/webhook/stripe]
    D --> E
  end

  subgraph åç«¯æ•°æ®å¤„ç†
    E --> F[Firestore preorders/{id}]
    E --> G[Klaviyo track äº‹ä»¶]
  end

  F --> H[è®¢å•ç®¡ç† & åˆ†æ]
  G --> I[Klaviyo è¥é”€è‡ªåŠ¨åŒ– Flow]

å·²å®ç°çš„å…³é”®ç‚¹ï¼š
	â€¢	æ”¯æŒ email + color çš„â€œä¸€è·³æ”¯ä»˜â€ï¼Œæå‡è½¬åŒ–ï¼›
	â€¢	åœ¨ payment_intent.created æŠ“å–æ½œåœ¨å®¢æˆ·çº¿ç´¢ï¼›
	â€¢	payment_intent.succeeded ä¸ checkout.session.completed æ›´æ–°è®¢å•çŠ¶æ€ï¼›
	â€¢	æ‰€æœ‰æ•°æ®ç»Ÿä¸€å†™å…¥ Firestoreï¼Œå¹¶å‘é€åˆ° Klaviyoï¼›
	â€¢	Webhook æœåŠ¡å…·å¤‡å¹‚ç­‰è®¾è®¡ï¼Œé˜²æ­¢é‡å¤è§¦å‘ã€‚

â¸»

ğŸ”§ äºŒã€Stripe â†” Klaviyo é›†æˆæœ€ä½³å®è·µ

æ ¹æ® Klaviyo å®˜æ–¹æ–‡æ¡£ï¼Œæ¨èæµç¨‹å¦‚ä¸‹ï¼š
	1.	åœ¨ Klaviyo â€œIntegrationsâ€ ä¸­å¯ç”¨ Stripeï¼Œå¹¶æˆæƒ Stripe è´¦æˆ·ï¼›
	2.	é…ç½® Stripe Webhookï¼Œå°† payment_intent.* å’Œ checkout.session.completed äº‹ä»¶åŒæ­¥åˆ° Klaviyoï¼›
	3.	Klaviyo å°†è‡ªåŠ¨æ¥æ”¶è¯¸å¦‚â€œSuccessfully Paidâ€â€œPayment Refundedâ€ç­‰äº‹ä»¶ï¼Œç”Ÿæˆå¯¹ç”¨æˆ·çš„ email è§¦å‘æµ  ï¿¼ï¼›
4. ä½ ä¹Ÿå¯ä»¥é€šè¿‡ Zapier æˆ– Appy Pie Automateï¼Œå†è‡ªå®šä¹‰è§¦å‘ç‰¹å®š Klaviyo events  ï¿¼ã€‚

è¿™ç§æ–¹å¼æ— éœ€è‡ªå†™ pushï¼ŒKlaviyo ä¼šè‡ªåŠ¨æ‹¿åˆ° Stripe åŒæ­¥ä¿¡æ¯ï¼ŒåŒ…æ‹¬é¡¾å®¢é‚®ç®±ã€æ”¯ä»˜è¯¦æƒ…å’Œé¢„è´­å…ƒæ•°æ®ã€‚

â¸»

âœ… ä¸‰ã€v2.0 ä¼˜åŒ–å»ºè®®

ç‰ˆæœ¬	å·²å®ç°	v2.0 å¢å¼ºå»ºè®®
ğŸ‘¤ çº¿ç´¢æ•è·	âœ… payment_intent.created å­˜å‚¨ email+color	- å‘ Klaviyo å‘é€â€œRolitt Pre-order Startâ€äº‹ä»¶ï¼Œå¼€å¯åŠ¨çº¿ç´¢è¿½è¸ªæµ- Segment åˆ›å»ºâ€œAbandoned Preorderâ€æ ‡ç­¾
ğŸ” Webhook å¹‚ç­‰	âœ… Firestore å¹‚ç­‰å†™å…¥	- å¢åŠ  Stripe ç­¾åéªŒè¯é€»è¾‘ï¼Œæå‡å®‰å…¨
ğŸ”„ æ”¯ä»˜çŠ¶æ€åŒæ­¥	âœ… succeeded + completed çŠ¶æ€æ›´æ–°	- å‘ Klaviyo æ¨é€è®¢é˜…äº‹ä»¶ï¼Œå¹¶å°†ç”¨æˆ·åŠ å…¥æˆåŠŸé¢„è®¢å• Segment
ğŸ“§ Klaviyo äº‹ä»¶é€»è¾‘	âœ… æ”¯æŒæˆåŠŸé‚®ä»¶è§¦è¾¾	- æ„å»ºâ€œé¢„å”®å€’è®¡æ—¶æé†’â€+â€œæ”¾å¼ƒæé†’â€é‚®ä»¶ Flow- Flow ä¸­åŠ å…¥ color å’Œ preorder_number åŠ¨æ€å‚æ•°å›å¤
ğŸ§® æ•°æ®è¿½è¸ª	âœ… Firestore å·²ç»“æ„åŒ–å­˜å‚¨	- Firestore å¢åŠ  utm_params, referrer, campaignï¼Œç”¨äºåç»­æŠ•æ”¾æ•ˆæœåˆ†æ
ğŸ§ª æµ‹è¯• & ç›‘æ§	âœ… stripe listen æµ‹è¯•	- å¼•å…¥ Sentry / Datadog ç›‘æ§ Webhook å¤±è´¥- Firestore å¢åŠ  trigger æŠ¥é”™å‘Šè­¦


â¸»

ğŸ›  å››ã€å®ç°æ–°åŠŸèƒ½å‚è€ƒç¤ºä¾‹
	1.	çº¿ç´¢è¿½è¸ªäº‹ä»¶å‘ Klaviyoï¼š

if (event.type === 'payment_intent.created') {
  Klaviyo.track('Rolitt Preorder Started',{ 
    email, color, preorder_number 
  });
}


	2.	æˆåŠŸè´­ä¹°åŠ å…¥ Segmentï¼š

Klaviyo.identify({
  email,
  properties: { preorder_number, color }
});
Klaviyo.track('Rolitt Preorder Completed', {...});


	3.	FireStore æ›´æ–°åŠ å…¥ referrer å­—æ®µï¼š

const utm = req.headers['referer']?.split('?')[1] || '';
firestore.doc(...).set({
    referrer: utm,
}, { merge: true });


	4.	Stripe Webhook ç­¾åæ ¡éªŒï¼š

const sig = req.headers['stripe-signature'];
stripe.webhooks.constructEvent(rawBody, sig, STRIPE_WEBHOOK_SECRET);



â¸»

ğŸ“ˆ äº”ã€æ¨è Klaviyo Flow å…¬å¼
	â€¢	é¢„å”®å¯åŠ¨æé†’ï¼šç”¨æˆ·è§¦å‘ Rolitt Preorder Startedï¼Œ24h åæ¨é€ä»˜æ¬¾æé†’ï¼›
	â€¢	ä»˜æ¬¾æˆåŠŸæ„Ÿè°¢ï¼šè§¦å‘ Rolitt Preorder Completedï¼Œç«‹å³å‘é€æ„Ÿè°¢ + åç»­ç‰©æµæ¶ˆæ¯ï¼›
	â€¢	é—å¼ƒæ”¯ä»˜æé†’ï¼šç›‘å¬ Started ä½† 48h æ— æˆåŠŸï¼ŒåŠ å…¥ â€œAbandoned Preorderâ€ user segment è§¦å‘å‚¬ä»˜é‚®ä»¶ï¼›
	â€¢	å˜ä½“æ¨èï¼šå¦‚æœæŸ color é”€é‡é«˜ï¼Œå¯å‘ç›¸ä¼¼ color æ¨èé‚®ä»¶ï¼ˆä¾ç…§ metadataï¼‰ã€‚

â¸»

ğŸ§© å…­ã€v2.0 é›†æˆæµç¨‹æ€»è§ˆ
	1.	å¼ºåŒ– Klaviyo Stripe Native Integration & Webhookï¼›
	2.	Webhook æœåŠ¡æ¨é€åŒäº‹ä»¶ä¸åŒ Flow Triggerï¼›
	3.	Firestore å¢å¼ºè¿½è¸ªå­—æ®µï¼›
	4.	v2.0 å‰ç«¯åŠ å…¥åƒ UTM/referrer æ•°æ®é‡‡é›†ï¼›
	5.	Flow ä¸­å¼•å…¥ä¼˜æƒ è¿”åˆ©/å€’è®¡æ—¶æé†’è§¦å‘é€»è¾‘ã€‚

â¸»

ğŸ¯ æ€»ç»“

ä½ ç›®å‰çš„é›†æˆåœ¨é«˜è½¬åŒ–è·¯å¾„ã€æ•°æ®ä¸€è‡´æ€§ã€è¥é”€é—­ç¯ä¸Šè¡¨ç°ä¼˜ç§€ã€‚v2.0 å»ºè®®åŠ æ·±çº¿ç´¢è¯†åˆ«èƒ½åŠ›ã€æ‰©å±•é‚®ä»¶ç­–ç•¥ã€å¼ºåŒ–ç›‘æ§ä¸å®‰å…¨ï¼Œå¯æ˜æ˜¾æå‡è¥é”€è½¬æ¢ä¸ç”¨æˆ·ä½“éªŒã€‚

å¦‚æœéœ€è¦ï¼Œæˆ‘å¯ä»¥ä¸ºä½ æä¾›å®Œæ•´çš„ Next.js + Node.js ä»£ç æ¨¡æ¿ã€Flow é…ç½®ç¤ºä¾‹ã€ç”šè‡³ CI/CD æµ‹è¯•è„šæœ¬ï¼Œéšæ—¶å¸®ä½ è½åœ°æå‡ï¼