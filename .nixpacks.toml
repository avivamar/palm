# Railway NIXPACKS é…ç½® - Next.js ç¯å¢ƒå˜é‡ä¼˜åŒ–ç‰ˆ

[phases.setup]
nixPkgs = [
  'nodejs_20',
  'npm-9_x'
]

# å®‰è£…ä¾èµ–
[phases.install]
cmds = [ 'npm ci --omit=dev --no-audit --no-fund' ]

# æ„å»ºé˜¶æ®µ - è§£å†³ Next.js ç¯å¢ƒå˜é‡é—®é¢˜
[phases.build]
dependsOn = [ "install" ]
cmds = [
  # ğŸ¯ å…³é”®ï¼šå°† Railway è¿è¡Œæ—¶å˜é‡æ˜ å°„åˆ° Next.js æ„å»ºæ—¶å˜é‡
  'echo "Setting up Next.js environment variables for build..."',
  'export NEXT_PUBLIC_SUPABASE_URL=$SUPABASE_URL',
  'export NEXT_PUBLIC_SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY',
  'export NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=$STRIPE_PUBLISHABLE_KEY',
  'export NEXT_PUBLIC_APP_URL=$RAILWAY_PUBLIC_DOMAIN',

  # è°ƒè¯•ï¼šè¾“å‡ºç¯å¢ƒå˜é‡çŠ¶æ€
  'echo "Build-time env check:"',
  'echo "NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL:0:20}..."',
  'echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY:0:20}..."',

  # æ‰§è¡Œæ„å»º
  'npm run build',

  # ç¡®ä¿å¯åŠ¨è„šæœ¬æœ‰æ‰§è¡Œæƒé™
  'chmod +x scripts/railway-start.sh'
]

[start]
cmd = 'npm start'

# ç¯å¢ƒå˜é‡é…ç½®
[variables]
NODE_ENV = 'production'
NEXT_TELEMETRY_DISABLED = '1'
PORT = '3000'

# æ„å»ºé…ç½®
[build]
cache = false
timeout = 1800
