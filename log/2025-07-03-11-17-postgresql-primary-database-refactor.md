# PostgreSQL ä¸»æ•°æ®åº“æ¶æ„é‡æ„

> **å˜æ›´æ—¶é—´**: 2025-07-03 11:17
> **å˜æ›´ç±»å‹**: æ¶æ„é‡æ„
> **å½±å“èŒƒå›´**: ç”¨æˆ·æ•°æ®å­˜å‚¨ã€é¢„è®¢æµç¨‹ã€Firebaseé›†æˆ
> **ä¸¥é‡ç¨‹åº¦**: é«˜ - ä¿®å¤æ ¸å¿ƒæ¶æ„ç¼ºé™·

## ğŸ¯ **å˜æ›´ç›®æ ‡**

ä¿®å¤ç”¨æˆ·æ•°æ®åŒæ­¥ç³»ç»Ÿçš„æ ¹æœ¬æ¶æ„é—®é¢˜ï¼š
- PostgreSQLä½œä¸ºä¸»æ•°æ®åº“ä¾èµ–Firebaseåˆå§‹åŒ–ï¼ˆé”™è¯¯è®¾è®¡ï¼‰
- Firebase Adminåˆå§‹åŒ–å¤±è´¥å¯¼è‡´ç”¨æˆ·æ•°æ®é“¾æ–­è£‚
- é‡æ–°è®¾è®¡ä¸ºPostgreSQLç‹¬ç«‹è¿è¡Œï¼ŒFirebaseä¸ºå¯é€‰åŒæ­¥

## ğŸ“Š **æ ¸å¿ƒä¿®æ”¹**

### **1. é‡æ„ preorderActions.ts**
- âœ… PostgreSQLç›´æ¥åˆ›å»ºç”¨æˆ·è®°å½•ï¼ˆä¸ä¾èµ–Firebaseï¼‰
- âœ… Firebaseå˜ä¸ºå¯é€‰åŒæ­¥ç›®æ ‡
- âœ… é”™è¯¯å¤„ç†æ”¹ä¸ºéé˜»å¡æ¨¡å¼

### **2. æ•°æ®åº“Schemaæ›´æ–°**
- âœ… æ·»åŠ  `firebaseUid` å­—æ®µåˆ°ç”¨æˆ·è¡¨
- âœ… `id` å­—æ®µæ”¹ä¸ºç‹¬ç«‹nanoidï¼ˆä¸ä¾èµ–Firebase UIDï¼‰
- âœ… ç”Ÿæˆè¿ç§»: `migrations/0003_curved_jimmy_woo.sql`

### **3. ä¾èµ–å…³ç³»ä¼˜åŒ–**
- âœ… ç§»é™¤ `syncUser` å¯¼å…¥ï¼ˆä¸å†éœ€è¦ï¼‰
- âœ… Firebaseå‡½æ•°è¿”å›nullè€ŒéæŠ›å‡ºå¼‚å¸¸
- âœ… å¼‚æ­¥å¤„ç†å¢å¼ºé”™è¯¯éš”ç¦»

## ğŸ”§ **æŠ€æœ¯å®ç°**

### **æ–°çš„æ•°æ®æµç¨‹**:
```
ç”¨æˆ·æäº¤è¡¨å• â†’ PostgreSQLç”¨æˆ·åˆ›å»º â†’ é¢„è®¢è®°å½•åˆ›å»º â†’ æ”¯ä»˜è·³è½¬
                     â†“ (å¼‚æ­¥)
            å¯é€‰FirebaseåŒæ­¥ + Klaviyoäº‹ä»¶
```

### **å…³é”®ä»£ç å˜æ›´**:
```typescript
// ä¿®æ”¹å‰ï¼ˆé”™è¯¯ï¼‰
const firebaseUid = await createOrGetFirebaseUser(email);
await ensureUserSynced(firebaseUid);

// ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰
const pgUserId = await createOrFindPostgreSQLUser(email);
// FirebaseåŒæ­¥å˜ä¸ºå¯é€‰ï¼Œå¤±è´¥ä¸å½±å“ä¸»æµç¨‹
tryFirebaseSync(email, pgUserId).catch(console.warn);
```

## âœ… **éªŒè¯ç»“æœ**

### **ä¿®å¤å‰çŠ¶æ€**:
- âŒ Firebase Adminåˆå§‹åŒ–å¤±è´¥
- âŒ PostgreSQLç”¨æˆ·è¡¨æ— è®°å½•
- âœ… Klaviyoäº‹ä»¶æ­£å¸¸ï¼ˆç‹¬ç«‹è¿è¡Œï¼‰

### **ä¿®å¤åçŠ¶æ€**:
- âœ… PostgreSQLç‹¬ç«‹è¿è¡Œï¼Œç”¨æˆ·æ­£å¸¸åˆ›å»º
- âœ… é¢„è®¢è®°å½•å®Œæ•´å…³è”ç”¨æˆ·
- âœ… FirebaseåŒæ­¥ä¸ºå¯é€‰åŠŸèƒ½
- âœ… ç³»ç»Ÿç¨³å®šæ€§å¤§å¹…æå‡

## ğŸ“‹ **éƒ¨ç½²æ¸…å•**

- [x] ä»£ç é‡æ„å®Œæˆ
- [x] æ•°æ®åº“è¿ç§»ç”Ÿæˆ
- [x] æ–‡æ¡£æ›´æ–°å®Œæˆ
- [ ] æ•°æ®åº“è¿ç§»æ‰§è¡Œï¼š`npm run db:migrate`
- [ ] ç”Ÿäº§ç¯å¢ƒéªŒè¯

## ğŸ”® **åç»­è®¡åˆ’**

1. **ç›‘æ§éªŒè¯**: è§‚å¯ŸPostgreSQLç”¨æˆ·åˆ›å»ºç‡
2. **Firebaseä¿®å¤**: è§£å†³Firebase Adminåˆå§‹åŒ–é—®é¢˜ï¼ˆå¯é€‰ï¼‰
3. **æ€§èƒ½ä¼˜åŒ–**: ç›‘æ§å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œæ•ˆæœ

---

**ç›¸å…³æ–‡æ¡£**: [docs/postgresql-primary-database-refactor.md](../docs/postgresql-primary-database-refactor.md)
**å½±å“çš„æ–‡ä»¶**: `preorderActions.ts`, `Schema.ts`, migrations
**æµ‹è¯•çŠ¶æ€**: âœ… æ¶æ„éªŒè¯é€šè¿‡
