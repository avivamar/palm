# ç®¡ç†å‘˜æƒé™ç³»ç»Ÿå®Œæ•´å®æ–½æŠ¥å‘Š

**æ—¥æœŸ**: 2025-07-09
**ä»»åŠ¡**: å®ç°å®Œæ•´çš„ç®¡ç†å‘˜æƒé™éªŒè¯ç³»ç»Ÿ
**çŠ¶æ€**: âœ… å®Œæˆ

## ğŸ“‹ é—®é¢˜åˆ†æ

### åŸæœ‰ç³»ç»Ÿé—®é¢˜
1. **middleware.ts æƒé™æ£€æŸ¥ä¸å®Œæ•´**: åªæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯ï¼Œæ²¡æœ‰æ£€æŸ¥æ•°æ®åº“ä¸­çš„ role å­—æ®µ
2. **API éªŒè¯ç¼ºå¤±è§’è‰²æ£€æŸ¥**: `/api/auth/verify-session` åªè¿”å› `isAuthenticated` å’Œ `uid`ï¼Œæ²¡æœ‰æŸ¥è¯¢æ•°æ®åº“è·å–ç”¨æˆ·çš„ role ä¿¡æ¯
3. **Admin Layout æƒé™æ£€æŸ¥è¢«æ³¨é‡Š**: `src/app/[locale]/admin/layout.tsx` ä¸­çš„æƒé™éªŒè¯ä»£ç è¢«æ³¨é‡Šæ‰äº†
4. **ç¼ºå°‘ç”¨æˆ·è§’è‰²æŸ¥è¯¢å‡½æ•°**: æ²¡æœ‰æ ¹æ® Firebase UID æŸ¥è¯¢æ•°æ®åº“ä¸­ç”¨æˆ· role çš„å‡½æ•°

## ğŸ”§ å®æ–½æ–¹æ¡ˆ

### 1. åˆ›å»ºç”¨æˆ·è§’è‰²æŸ¥è¯¢å‡½æ•°

**æ–‡ä»¶**: `src/app/actions/userActions.ts`

**æ–°å¢åŠŸèƒ½**:
- `getUserRole(userId: string)`: æ ¹æ®ç”¨æˆ·IDè·å–ç”¨æˆ·è§’è‰²
- `isUserAdmin(userId: string)`: æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜

```typescript
/**
 * æ ¹æ®ç”¨æˆ·IDè·å–ç”¨æˆ·è§’è‰²
 * @param userId Firebase UID
 * @returns ç”¨æˆ·è§’è‰²ä¿¡æ¯
 */
export async function getUserRole(userId: string): Promise<{ success: boolean; role?: string; error?: string }>;

/**
 * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜
 * @param userId Firebase UID
 * @returns æ˜¯å¦ä¸ºç®¡ç†å‘˜
 */
export async function isUserAdmin(userId: string): Promise<{ success: boolean; isAdmin?: boolean; error?: string }>;
```

### 2. ä¿®æ”¹ API éªŒè¯ä¼šè¯è·¯ç”±

**æ–‡ä»¶**: `src/app/api/auth/verify-session/route.ts`

**æ›´æ”¹å†…å®¹**:
- å¯¼å…¥ `getUserRole` å‡½æ•°
- åœ¨éªŒè¯ä¼šè¯æˆåŠŸåæŸ¥è¯¢ç”¨æˆ·è§’è‰²
- è¿”å›å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯åŒ…æ‹¬è§’è‰²å’Œç®¡ç†å‘˜çŠ¶æ€

**æ–°çš„è¿”å›æ ¼å¼**:
```json
{
  "isAuthenticated": true,
  "uid": "user-uid",
  "role": "admin",
  "isAdmin": true
}
```

### 3. ä¸­é—´ä»¶æƒé™æ£€æŸ¥

**æ–‡ä»¶**: `src/middleware.ts`

**ç°çŠ¶**: âœ… å·²ç»åŒ…å«å®Œæ•´çš„ç®¡ç†å‘˜æƒé™æ£€æŸ¥é€»è¾‘
- å®šä¹‰äº† `adminOnlyRoutes = ['/admin']`
- ä» `/api/auth/verify-session` è·å– `isAdmin` çŠ¶æ€
- å¯¹ç®¡ç†å‘˜è·¯ç”±è¿›è¡Œæƒé™éªŒè¯
- éç®¡ç†å‘˜ç”¨æˆ·è®¿é—®ç®¡ç†å‘˜è·¯ç”±æ—¶é‡å®šå‘åˆ° `/dashboard`

### 4. Admin Layout æƒé™æ£€æŸ¥

**æ–‡ä»¶**: `src/app/[locale]/admin/layout.tsx`

**ç°çŠ¶**: âœ… æƒé™æ£€æŸ¥å·²å¯ç”¨
- å®ç°äº† `verifyAdminAccess()` å‡½æ•°
- ä½¿ç”¨ `getUserRole()` éªŒè¯ç”¨æˆ·è§’è‰²
- éç®¡ç†å‘˜ç”¨æˆ·è‡ªåŠ¨é‡å®šå‘åˆ° `/dashboard`

## ğŸ› ï¸ å·¥å…·è„šæœ¬

### 1. ç”¨æˆ·è§’è‰²æ›´æ–°è„šæœ¬

**æ–‡ä»¶**: `scripts/update-user-role.ts`

**åŠŸèƒ½**:
- æ›´æ–°æŒ‡å®šç”¨æˆ·çš„è§’è‰²
- æ”¯æŒ `customer`ã€`admin`ã€`moderator` ä¸‰ç§è§’è‰²
- æä¾›è¯¦ç»†çš„æ“ä½œåé¦ˆ

**ä½¿ç”¨æ–¹æ³•**:
```bash
npx tsx scripts/update-user-role.ts aviva.mar@gmail.com admin
```

### 2. æƒé™ç³»ç»Ÿæµ‹è¯•è„šæœ¬

**æ–‡ä»¶**: `scripts/test-admin-permissions.ts`

**åŠŸèƒ½**:
- æµ‹è¯•æ‰€æœ‰ç”¨æˆ·çš„è§’è‰²æŸ¥è¯¢åŠŸèƒ½
- éªŒè¯ç®¡ç†å‘˜æ£€æŸ¥å‡½æ•°
- æä¾›ç³»ç»ŸçŠ¶æ€æ€»ç»“

**ä½¿ç”¨æ–¹æ³•**:
```bash
npx tsx scripts/test-admin-permissions.ts
```

## ğŸ” æƒé™ç³»ç»Ÿæ¶æ„

### å¤šå±‚æƒé™éªŒè¯

1. **ä¸­é—´ä»¶å±‚** (`middleware.ts`)
   - è·¯ç”±çº§åˆ«çš„æƒé™æ§åˆ¶
   - é‡å®šå‘æœªæˆæƒç”¨æˆ·

2. **API å±‚** (`/api/auth/verify-session`)
   - ä¼šè¯éªŒè¯å’Œè§’è‰²ä¿¡æ¯è·å–
   - ç»Ÿä¸€çš„è®¤è¯çŠ¶æ€ç®¡ç†

3. **Layout å±‚** (`admin/layout.tsx`)
   - é¡µé¢çº§åˆ«çš„æƒé™éªŒè¯
   - æœåŠ¡ç«¯æ¸²æŸ“æ—¶çš„å®‰å…¨æ£€æŸ¥

4. **æ•°æ®åº“å±‚** (`userActions.ts`)
   - è§’è‰²æ•°æ®çš„æŸ¥è¯¢å’ŒéªŒè¯
   - ç±»å‹å®‰å…¨çš„æ•°æ®åº“æ“ä½œ

### è§’è‰²å®šä¹‰

```typescript
type UserRole = 'customer' | 'admin' | 'moderator';
```

- **customer**: é»˜è®¤è§’è‰²ï¼Œåªèƒ½è®¿é—® `/dashboard`
- **admin**: ç®¡ç†å‘˜è§’è‰²ï¼Œå¯ä»¥è®¿é—® `/dashboard` å’Œ `/admin`
- **moderator**: ç‰ˆä¸»è§’è‰²ï¼Œå¯ä»¥è®¿é—® `/dashboard` å’Œéƒ¨åˆ†ç®¡ç†åŠŸèƒ½

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯

1. **æœªè®¤è¯ç”¨æˆ·**
   - è®¿é—® `/admin` â†’ é‡å®šå‘åˆ° `/sign-in`
   - è®¿é—® `/dashboard` â†’ é‡å®šå‘åˆ° `/sign-in`

2. **Customer è§’è‰²ç”¨æˆ·**
   - è®¿é—® `/dashboard` â†’ âœ… å…è®¸è®¿é—®
   - è®¿é—® `/admin` â†’ é‡å®šå‘åˆ° `/dashboard`

3. **Admin è§’è‰²ç”¨æˆ·**
   - è®¿é—® `/dashboard` â†’ âœ… å…è®¸è®¿é—®
   - è®¿é—® `/admin` â†’ âœ… å…è®¸è®¿é—®

### éªŒè¯æ­¥éª¤

1. è¿è¡Œæƒé™æµ‹è¯•è„šæœ¬
```bash
npx tsx scripts/test-admin-permissions.ts
```

2. æ›´æ–°ç”¨æˆ·è§’è‰²ä¸ºç®¡ç†å‘˜
```bash
npx tsx scripts/update-user-role.ts aviva.mar@gmail.com admin
```

3. ç”¨æˆ·é‡æ–°ç™»å½•è·å¾—æ–°æƒé™

4. æµ‹è¯•è®¿é—® `/admin` è·¯ç”±

## ğŸ“ å®æ–½æ€»ç»“

### âœ… å·²å®Œæˆçš„åŠŸèƒ½

1. **ç”¨æˆ·è§’è‰²æŸ¥è¯¢ç³»ç»Ÿ**
   - `getUserRole()` å‡½æ•°å®ç°
   - `isUserAdmin()` å‡½æ•°å®ç°
   - å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œç±»å‹å®‰å…¨

2. **API æƒé™éªŒè¯**
   - `/api/auth/verify-session` è¿”å›è§’è‰²ä¿¡æ¯
   - ç»Ÿä¸€çš„è®¤è¯çŠ¶æ€ç®¡ç†

3. **è·¯ç”±æƒé™ä¿æŠ¤**
   - ä¸­é—´ä»¶å±‚é¢çš„æƒé™æ£€æŸ¥
   - Admin Layout çš„æœåŠ¡ç«¯æƒé™éªŒè¯

4. **ç®¡ç†å·¥å…·**
   - ç”¨æˆ·è§’è‰²æ›´æ–°è„šæœ¬
   - æƒé™ç³»ç»Ÿæµ‹è¯•è„šæœ¬

### ğŸ”„ ç”¨æˆ·æ“ä½œæµç¨‹

1. **ç®¡ç†å‘˜æƒé™æˆäºˆ**:
   ```bash
   npx tsx scripts/update-user-role.ts aviva.mar@gmail.com admin
   ```

2. **ç”¨æˆ·é‡æ–°ç™»å½•**: è·å¾—æ–°çš„ä¼šè¯å’Œæƒé™

3. **è®¿é—®ç®¡ç†é¢æ¿**: ç°åœ¨å¯ä»¥è®¿é—® `/admin` è·¯ç”±

### ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

- **å¤šå±‚éªŒè¯**: ä¸­é—´ä»¶ + API + Layout ä¸‰å±‚æƒé™æ£€æŸ¥
- **ä¼šè¯å®‰å…¨**: Firebase ä¼šè¯ cookie éªŒè¯
- **æ•°æ®åº“ä¸€è‡´æ€§**: è§’è‰²ä¿¡æ¯å­˜å‚¨åœ¨ PostgreSQL ä¸­
- **ç±»å‹å®‰å…¨**: TypeScript ä¸¥æ ¼ç±»å‹æ£€æŸ¥
- **é”™è¯¯å¤„ç†**: å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

1. **è§’è‰²ç»†åŒ–**: å¯ä»¥è€ƒè™‘æ·»åŠ æ›´å¤šç»†ç²’åº¦çš„æƒé™æ§åˆ¶
2. **æƒé™ç¼“å­˜**: å®ç°è§’è‰²ä¿¡æ¯çš„å®¢æˆ·ç«¯ç¼“å­˜æœºåˆ¶
3. **å®¡è®¡æ—¥å¿—**: æ·»åŠ ç®¡ç†å‘˜æ“ä½œçš„å®¡è®¡æ—¥å¿—
4. **æƒé™ç®¡ç†ç•Œé¢**: åˆ›å»ºç®¡ç†å‘˜æƒé™ç®¡ç†çš„ UI ç•Œé¢

---

**å®æ–½å®Œæˆ**: ç®¡ç†å‘˜æƒé™ç³»ç»Ÿå·²å®Œå…¨å®ç°å¹¶å¯æŠ•å…¥ä½¿ç”¨ã€‚ç”¨æˆ· `aviva.mar@gmail.com` ç°åœ¨å¯ä»¥é€šè¿‡æ•°æ®åº“è§’è‰²ä¿®æ”¹è·å¾—ç®¡ç†å‘˜æƒé™ã€‚
